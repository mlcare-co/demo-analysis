<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOS Analysis - Visualization Suite</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>
    <style>
        @media (max-width: 768px) {
    .container { padding: 15px; font-size: 14px; }
    h1 { font-size: 1.6rem; }
    h2 { font-size: 1.2rem; margin: 20px 0 10px; }
    .metric-card { padding: 12px; }
    .metric-value { font-size: 1.8rem; }
    .chart-container { padding: 10px; margin: 15px 0; }
    .chart-title { font-size: 0.9rem; }
    table { font-size: 12px; }
    td, th { padding: 6px; }
    .insight-box { padding: 12px; font-size: 0.9rem; }
        } 
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #f5f7fa;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        
        h2 {
            color: #34495e;
            margin-top: 40px;
            margin-bottom: 20px;
            padding: 10px;
            background: #ecf0f1;
            border-left: 4px solid #3498db;
        }
        
        .chart-container {
            margin: 30px 0;
            padding: 20px;
            background: #fdfdfd;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .metric-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .insight-box {
            background: #e8f4f8;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        
        .table-container {
            overflow-x: auto;
            margin: 20px 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        th {
            background: #34495e;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        
        td {
            padding: 10px 12px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .footer {
            margin-top: 50px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
            text-align: center;
            color: #7f8c8d;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Length of Stay (LOS) Analysis - 500-Bed European Hospital</h1>
        
        <div class="insight-box">
            <strong>Analysis Period:</strong> January 2024 - December 2024<br>
            <strong>Total Discharges:</strong> 15,000 patients<br>
            <strong>Methodology:</strong> Comparison against national DRG-specific benchmarks (GMLOS)
        </div>

        <!-- Key Metrics Dashboard -->
        <h2>Executive Summary Metrics</h2>
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-label">Mean LOS (Actual)</div>
                <div class="metric-value">5.9 days</div>
                <div class="metric-label">vs 5.1 benchmark</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Total Excess Bed-Days</div>
                <div class="metric-value">12,000</div>
                <div class="metric-label">0.8 days per patient</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Patients > Trim Point</div>
                <div class="metric-value">15%</div>
                <div class="metric-label">2,250 patients</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Financial Impact</div>
                <div class="metric-value">€3.9M</div>
                <div class="metric-label">at €325/day variable cost</div>
            </div>
        </div>

        <!-- Chart 1: Distribution Analysis -->
        <h2>1. Hospital-wide LOS Distribution</h2>
        <div class="chart-container">
            <div class="chart-title">Actual vs Benchmark LOS Distribution</div>
            <div id="distribution-chart"></div>
        </div>

        <!-- Chart 2: Department Funnel Plot -->
        <h2>2. Department Performance - Funnel Plot</h2>
        <div class="chart-container">
            <div class="chart-title">Observed/Expected Ratio by Department Volume</div>
            <div id="funnel-plot"></div>
        </div>

        <!-- Chart 3: Top DRGs -->
        <h2>3. Top 10 DRGs Contributing to Excess Days</h2>
        <div class="chart-container">
            <div class="chart-title">DRGs Ranked by Total Excess Bed-Days</div>
            <div id="drg-chart"></div>
        </div>

        <!-- Chart 4: Patient Stratification -->
        <h2>4. LOS by Patient Characteristics</h2>
        <div class="chart-container">
            <div class="chart-title">Mean LOS Stratified by Key Factors</div>
            <div id="stratification-chart"></div>
        </div>

        <!-- Chart 5: Time Series -->
        <h2>5. Monthly Trend Analysis</h2>
        <div class="chart-container">
            <div class="chart-title">12-Month LOS Trend with Moving Average</div>
            <div id="timeseries-chart"></div>
        </div>

        <!-- Chart 6: Financial Waterfall -->
        <h2>6. Financial Impact Waterfall</h2>
        <div class="chart-container">
            <div class="chart-title">Cost Build-up from Excess Bed-Days</div>
            <div id="waterfall-chart"></div>
        </div>

        <!-- Chart 7: Department-DRG Heatmap -->
        <h2>7. Department × DRG Performance Matrix</h2>
        <div class="chart-container">
            <div class="chart-title">Excess Days Heatmap (Days Above Benchmark)</div>
            <div id="heatmap-chart"></div>
        </div>

        <!-- Chart 8: Discharge Patterns -->
        <h2>8. Discharge Pattern Analysis</h2>
        <div class="chart-container">
            <div class="chart-title">Weekend vs Weekday Discharge Rates</div>
            <div id="discharge-pattern"></div>
        </div>

        <!-- Chart 9: Risk-Adjusted Scatter -->
        <h2>9. Risk-Adjusted Performance Scatter</h2>
        <div class="chart-container">
            <div class="chart-title">Expected vs Actual LOS by Physician (Risk-Adjusted)</div>
            <div id="scatter-plot"></div>
        </div>

        <!-- Chart 10: Caterpillar Plot -->
        <h2>10. Physician Performance - Caterpillar Plot</h2>
        <div class="chart-container">
            <div class="chart-title">Observed/Expected Ratio with 95% Confidence Intervals</div>
            <div id="caterpillar-plot"></div>
        </div>

        <!-- Data Table -->
        <h2>11. Department Detail Table</h2>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Department</th>
                        <th>Discharges</th>
                        <th>Mean LOS</th>
                        <th>Benchmark</th>
                        <th>O/E Ratio</th>
                        <th>Excess Days</th>
                        <th>Financial Impact</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Cardiology</td>
                        <td>2,850</td>
                        <td>6.8</td>
                        <td>5.5</td>
                        <td>1.24</td>
                        <td>3,705</td>
                        <td>€1,204,125</td>
                    </tr>
                    <tr>
                        <td>Orthopedics</td>
                        <td>2,100</td>
                        <td>7.2</td>
                        <td>6.1</td>
                        <td>1.18</td>
                        <td>2,310</td>
                        <td>€750,750</td>
                    </tr>
                    <tr>
                        <td>General Surgery</td>
                        <td>1,950</td>
                        <td>5.4</td>
                        <td>4.8</td>
                        <td>1.13</td>
                        <td>1,170</td>
                        <td>€380,250</td>
                    </tr>
                    <tr>
                        <td>Internal Medicine</td>
                        <td>3,200</td>
                        <td>6.1</td>
                        <td>5.3</td>
                        <td>1.15</td>
                        <td>2,560</td>
                        <td>€832,000</td>
                    </tr>
                    <tr>
                        <td>Neurology</td>
                        <td>1,150</td>
                        <td>5.2</td>
                        <td>4.9</td>
                        <td>1.06</td>
                        <td>345</td>
                        <td>€112,125</td>
                    </tr>
                    <tr>
                        <td>Pulmonology</td>
                        <td>1,400</td>
                        <td>5.8</td>
                        <td>5.2</td>
                        <td>1.12</td>
                        <td>840</td>
                        <td>€273,000</td>
                    </tr>
                    <tr>
                        <td>Gastroenterology</td>
                        <td>950</td>
                        <td>4.9</td>
                        <td>4.6</td>
                        <td>1.07</td>
                        <td>285</td>
                        <td>€92,625</td>
                    </tr>
                    <tr>
                        <td>Oncology</td>
                        <td>800</td>
                        <td>4.8</td>
                        <td>4.7</td>
                        <td>1.02</td>
                        <td>80</td>
                        <td>€26,000</td>
                    </tr>
                    <tr>
                        <td>Nephrology</td>
                        <td>600</td>
                        <td>5.5</td>
                        <td>5.0</td>
                        <td>1.10</td>
                        <td>300</td>
                        <td>€97,500</td>
                    </tr>
                    <tr style="font-weight: bold; background: #f0f0f0;">
                        <td>TOTAL</td>
                        <td>15,000</td>
                        <td>5.9</td>
                        <td>5.1</td>
                        <td>1.16</td>
                        <td>11,595</td>
                        <td>€3,768,375</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="insight-box">
            <strong>Key Findings:</strong><br>
            • Four departments (Cardiology, Orthopedics, Internal Medicine, General Surgery) account for 73% of excess bed-days<br>
            • Weekend discharge rate (19%) significantly lower than weekday rate (27%)<br>
            • Patients aged 80+ show 2.3 days longer LOS than those under 65<br>
            • Emergency admissions average 1.8 days longer than elective admissions
        </div>

        <div class="footer">
            Data Analysis Period: January 2024 - December 2024 | 500-Bed Hospital | 15,000 Discharges
        </div>
    </div>

    <script>
        // Wait for Plotly to load
        window.addEventListener('load', function() {
            
            // Chart 1: Distribution
            const distribution = {
                x: [],
                actual: [],
                benchmark: []
            };
            
            for(let i = 1; i <= 30; i++) {
                distribution.x.push(i);
                // Log-normal-like distribution
                distribution.actual.push(Math.exp(-Math.pow(i-5.9, 2)/50) * 1000);
                distribution.benchmark.push(Math.exp(-Math.pow(i-5.1, 2)/40) * 1200);
            }

            const trace1 = {
                x: distribution.x,
                y: distribution.actual,
                name: 'Actual LOS',
                type: 'scatter',
                fill: 'tozeroy',
                fillcolor: 'rgba(231, 76, 60, 0.3)',
                line: {color: '#e74c3c', width: 3}
            };

            const trace2 = {
                x: distribution.x,
                y: distribution.benchmark,
                name: 'Benchmark',
                type: 'scatter',
                fill: 'tozeroy',
                fillcolor: 'rgba(52, 152, 219, 0.3)',
                line: {color: '#3498db', width: 3}
            };

            const layout1 = {
                title: false,
                xaxis: {title: 'Length of Stay (days)'},
                yaxis: {title: 'Number of Patients'},
                hovermode: 'x unified',
                showlegend: true,
                height: 400
            };

            Plotly.newPlot('distribution-chart', [trace1, trace2], layout1, {responsive: true, displayModeBar: false});

            // Chart 2: Funnel Plot
            const departments = ['Cardiology', 'Orthopedics', 'General Surgery', 'Internal Medicine', 
                               'Neurology', 'Pulmonology', 'Gastroenterology', 'Oncology', 'Nephrology'];
            const volumes = [2850, 2100, 1950, 3200, 1150, 1400, 950, 800, 600];
            const oeRatios = [1.24, 1.18, 1.13, 1.15, 1.06, 1.12, 1.07, 1.02, 1.10];
            
            // Calculate control limits
            const upperLimit = volumes.map(v => 1 + 2/Math.sqrt(v));
            const lowerLimit = volumes.map(v => 1 - 2/Math.sqrt(v));

            const funnelTrace = {
                x: volumes,
                y: oeRatios,
                mode: 'markers+text',
                text: departments,
                textposition: 'top center',
                marker: {
                    size: 12,
                    color: oeRatios.map(r => r > 1.15 ? '#e74c3c' : (r > 1.10 ? '#f39c12' : '#27ae60')),
                },
                type: 'scatter',
                name: 'Departments'
            };

            const upperTrace = {
                x: volumes.sort((a,b) => a-b),
                y: volumes.sort((a,b) => a-b).map(v => 1 + 2/Math.sqrt(v)),
                mode: 'lines',
                line: {color: 'orange', dash: 'dash'},
                name: '95% Upper Limit'
            };

            const lowerTrace = {
                x: volumes.sort((a,b) => a-b),
                y: volumes.sort((a,b) => a-b).map(v => 1 - 2/Math.sqrt(v)),
                mode: 'lines',
                line: {color: 'orange', dash: 'dash'},
                name: '95% Lower Limit'
            };

            const centerLine = {
                x: [0, 3500],
                y: [1, 1],
                mode: 'lines',
                line: {color: 'gray', dash: 'dot'},
                name: 'Expected (1.0)'
            };

            const layout2 = {
                xaxis: {title: 'Annual Discharge Volume'},
                yaxis: {title: 'Observed/Expected Ratio', range: [0.9, 1.3]},
                height: 450,
                hovermode: 'closest'
            };

            Plotly.newPlot('funnel-plot', [funnelTrace, upperTrace, lowerTrace, centerLine], layout2, {responsive: true, displayModeBar: false});

            // Chart 3: Top DRGs
            const drgData = {
                drgs: ['DRG 470<br>(Hip/Knee)', 'DRG 291<br>(Heart Failure)', 'DRG 871<br>(Sepsis)', 
                      'DRG 190<br>(COPD)', 'DRG 378<br>(GI Bleed)', 'DRG 065<br>(Stroke)', 
                      'DRG 392<br>(Pneumonia)', 'DRG 247<br>(Perc Card)', 'DRG 481<br>(Hip Fracture)', 
                      'DRG 683<br>(Renal Failure)'],
                excessDays: [2100, 1850, 1620, 1480, 1250, 1100, 980, 870, 720, 630],
                volume: [450, 520, 380, 420, 310, 280, 350, 240, 180, 210]
            };

            const drgTrace = {
                x: drgData.excessDays,
                y: drgData.drgs,
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: drgData.excessDays,
                    colorscale: 'Reds'
                },
                text: drgData.excessDays.map((d, i) => `${d} days<br>(${drgData.volume[i]} cases)`),
                textposition: 'outside',
                hovertemplate: '%{y}: %{x} excess days<extra></extra>'
            };

            const layout3 = {
                xaxis: {title: 'Total Excess Bed-Days'},
                margin: {l: 150},
                height: 400
            };

            Plotly.newPlot('drg-chart', [drgTrace], layout3, {responsive: true, displayModeBar: false});

            // Chart 4: Patient Stratification
            const stratData = {
                categories: ['Age<br><65', 'Age<br>65-79', 'Age<br>80+', 'Elective', 'Emergency', 'Transfer',
                            'Home<br>Discharge', 'Rehab<br>Discharge', 'SNF<br>Discharge'],
                actual: [4.2, 5.8, 7.5, 4.8, 6.6, 8.2, 4.9, 7.8, 9.1],
                benchmark: [3.8, 5.0, 6.2, 4.2, 5.6, 6.8, 4.3, 6.5, 7.5]
            };

            const stratTrace1 = {
                x: stratData.categories,
                y: stratData.actual,
                name: 'Actual LOS',
                type: 'bar',
                marker: {color: '#e74c3c'}
            };

            const stratTrace2 = {
                x: stratData.categories,
                y: stratData.benchmark,
                name: 'Benchmark',
                type: 'bar',
                marker: {color: '#3498db'}
            };

            const layout4 = {
                barmode: 'group',
                yaxis: {title: 'Mean LOS (days)'},
                height: 400
            };

            Plotly.newPlot('stratification-chart', [stratTrace1, stratTrace2], layout4, {responsive: true, displayModeBar: false});

            // Chart 5: Time Series
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const monthlyLOS = [6.1, 6.0, 5.8, 5.9, 5.7, 5.8, 5.9, 6.0, 5.9, 5.8, 6.0, 6.1];
            const movingAvg = [6.0, 5.96, 5.90, 5.83, 5.80, 5.83, 5.87, 5.90, 5.90, 5.93, 5.97, 6.0];

            const timeTrace1 = {
                x: months,
                y: monthlyLOS,
                name: 'Monthly LOS',
                type: 'scatter',
                mode: 'lines+markers',
                line: {color: '#e74c3c', width: 2},
                marker: {size: 8}
            };

            const timeTrace2 = {
                x: months,
                y: movingAvg,
                name: '3-Month Moving Avg',
                type: 'scatter',
                mode: 'lines',
                line: {color: '#3498db', width: 2, dash: 'dash'}
            };

            const benchmarkLine = {
                x: months,
                y: Array(12).fill(5.1),
                name: 'Benchmark',
                type: 'scatter',
                mode: 'lines',
                line: {color: 'green', width: 1, dash: 'dot'}
            };

            const layout5 = {
                yaxis: {title: 'Mean LOS (days)', range: [4.5, 6.5]},
                xaxis: {title: 'Month (2024)'},
                height: 400
            };

            Plotly.newPlot('timeseries-chart', [timeTrace1, timeTrace2, benchmarkLine], layout5, {responsive: true, displayModeBar: false});

            // Chart 6: Financial Waterfall
            const waterfallData = {
                x: ['Expected<br>Bed-Days', 'Age 80+<br>Impact', 'Emergency<br>Admissions', 'Weekend<br>Effect', 
                    'HAC<br>Cases', 'Discharge<br>Delays', 'Total<br>Excess'],
                y: [0, 3200, 2800, 2100, 1800, 1700, 0],
                measure: ['absolute', 'relative', 'relative', 'relative', 'relative', 'relative', 'total'],
                text: ['76,500', '+3,200', '+2,800', '+2,100', '+1,800', '+1,700', '11,600'],
                textposition: 'outside',
                connector: {line: {color: 'rgb(63, 63, 63)'}},
                increasing: {marker: {color: '#e74c3c'}},
                decreasing: {marker: {color: '#27ae60'}},
                totals: {marker: {color: '#f39c12'}}
            };

            const waterfallTrace = {
                type: 'waterfall',
                orientation: 'v',
                x: waterfallData.x,
                y: waterfallData.y,
                text: waterfallData.text,
                textposition: waterfallData.textposition,
                measure: waterfallData.measure,
                connector: waterfallData.connector,
                increasing: waterfallData.increasing,
                totals: waterfallData.totals
            };

            const layout6 = {
                yaxis: {title: 'Bed-Days'},
                height: 450,
                showlegend: false
            };

            Plotly.newPlot('waterfall-chart', [waterfallTrace], layout6, {responsive: true, displayModeBar: false});

            // Chart 7: Heatmap
            const heatmapData = {
                z: [
                    [2.1, 1.8, 1.5, 0.8, 0.3],
                    [1.9, 1.6, 1.2, 0.6, 0.2],
                    [1.2, 0.9, 0.6, 0.3, 0.1],
                    [1.5, 1.1, 0.8, 0.4, 0.2],
                    [0.6, 0.4, 0.3, 0.2, 0.1]
                ],
                x: ['DRG 470', 'DRG 291', 'DRG 871', 'DRG 190', 'DRG 378'],
                y: ['Cardiology', 'Orthopedics', 'Surgery', 'Medicine', 'Neurology'],
                colorscale: 'RdYlGn',
                reversescale: true,
                type: 'heatmap',
                hovertemplate: '%{y}<br>%{x}<br>Excess: %{z} days<extra></extra>',
                colorbar: {title: 'Excess Days'}
            };

            const layout7 = {
                xaxis: {title: 'Top DRGs', side: 'top'},
                yaxis: {title: 'Department'},
                height: 400
            };

            Plotly.newPlot('heatmap-chart', [heatmapData], layout7, {responsive: true, displayModeBar: false});

            // Chart 8: Discharge Patterns
            const dischargeData = {
                days: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'],
                rate: [28, 29, 27, 28, 26, 19, 18],
                volume: [580, 605, 563, 584, 542, 396, 375]
            };

            const dischargeTrace = {
                x: dischargeData.days,
                y: dischargeData.rate,
                type: 'bar',
                marker: {
                    color: ['#3498db', '#3498db', '#3498db', '#3498db', '#3498db', '#e74c3c', '#e74c3c']
                },
                text: dischargeData.rate.map((r, i) => `${r}%<br>(${dischargeData.volume[i]} pts)`),
                textposition: 'outside'
            };

            const avgLine = {
                x: dischargeData.days,
                y: Array(7).fill(23.5),
                mode: 'lines',
                line: {color: 'gray', dash: 'dash'},
                name: 'Weekly Average'
            };

            const layout8 = {
                yaxis: {title: 'Discharge Rate (%)', range: [0, 35]},
                xaxis: {title: 'Day of Week'},
                height: 400,
                showlegend: false
            };

            Plotly.newPlot('discharge-pattern', [dischargeTrace, avgLine], layout8, {responsive: true, displayModeBar: false});

            // Chart 9: Risk-Adjusted Scatter Plot
            const scatterData = {
                physicians: [],
                expected: [],
                actual: [],
                volume: [],
                department: []
            };

            // Generate 40 anonymized physicians with realistic data
            const depts = ['Cardiology', 'Orthopedics', 'Surgery', 'Medicine', 'Neurology'];
            for(let i = 1; i <= 40; i++) {
                scatterData.physicians.push(`MD${String(i).padStart(3, '0')}`);
                const exp = 4 + Math.random() * 4; // Expected LOS between 4-8 days
                scatterData.expected.push(exp);
                // Add variation around expected (some over, some under)
                const variation = (Math.random() - 0.5) * 2 + 0.3;
                scatterData.actual.push(exp + variation);
                scatterData.volume.push(100 + Math.floor(Math.random() * 400));
                scatterData.department.push(depts[Math.floor(Math.random() * depts.length)]);
            }

            // Color by performance
            const colors = scatterData.actual.map((act, i) => {
                const ratio = act / scatterData.expected[i];
                if(ratio > 1.2) return '#e74c3c';
                if(ratio > 1.1) return '#f39c12';
                return '#27ae60';
            });

            const scatterTrace = {
                x: scatterData.expected,
                y: scatterData.actual,
                mode: 'markers',
                marker: {
                    size: scatterData.volume.map(v => v/10),
                    color: colors,
                    opacity: 0.7,
                    line: {
                        color: 'white',
                        width: 1
                    }
                },
                text: scatterData.physicians.map((p, i) => 
                    `${p}<br>Department: ${scatterData.department[i]}<br>Volume: ${scatterData.volume[i]} cases<br>Expected: ${scatterData.expected[i].toFixed(1)} days<br>Actual: ${scatterData.actual[i].toFixed(1)} days`
                ),
                hovertemplate: '%{text}<extra></extra>',
                type: 'scatter'
            };

            // Perfect performance line
            const perfLine = {
                x: [3, 9],
                y: [3, 9],
                mode: 'lines',
                line: {color: 'gray', dash: 'dash'},
                name: 'Perfect Performance',
                hoverinfo: 'skip'
            };

            // Control limit lines (±20%)
            const upperControl = {
                x: [3, 9],
                y: [3.6, 10.8],
                mode: 'lines',
                line: {color: 'orange', dash: 'dot'},
                name: '+20% Threshold',
                hoverinfo: 'skip'
            };

            const lowerControl = {
                x: [3, 9],
                y: [2.4, 7.2],
                mode: 'lines',
                line: {color: 'orange', dash: 'dot'},
                name: '-20% Threshold',
                hoverinfo: 'skip'
            };

            const layout9 = {
                xaxis: {title: 'Expected LOS (Risk-Adjusted)', range: [3, 9]},
                yaxis: {title: 'Actual LOS', range: [3, 10]},
                height: 450,
                showlegend: false,
                annotations: [{
                    x: 8.5,
                    y: 9.5,
                    text: 'Size = Volume',
                    showarrow: false,
                    font: {size: 11, color: 'gray'}
                }]
            };

            Plotly.newPlot('scatter-plot', [scatterTrace, perfLine, upperControl, lowerControl], layout9, {responsive: true, displayModeBar: false});

            // Chart 10: Caterpillar Plot
            const caterpillarData = {
                physicians: [],
                oeRatio: [],
                lowerCI: [],
                upperCI: [],
                significant: []
            };

            // Generate data for top 20 physicians by volume
            for(let i = 1; i <= 20; i++) {
                const physician = `MD${String(i).padStart(3, '0')}`;
                const ratio = 0.85 + Math.random() * 0.45; // O/E ratio between 0.85 and 1.30
                const ciWidth = 0.05 + Math.random() * 0.1; // CI width varies by volume
                
                caterpillarData.physicians.push(physician);
                caterpillarData.oeRatio.push(ratio);
                caterpillarData.lowerCI.push(ratio - ciWidth);
                caterpillarData.upperCI.push(ratio + ciWidth);
                // Significant if CI doesn't cross 1.0
                caterpillarData.significant.push(
                    (ratio - ciWidth > 1.0) || (ratio + ciWidth < 1.0)
                );
            }

            // Sort by O/E ratio
            const sortedIndices = caterpillarData.oeRatio
                .map((val, idx) => ({val, idx}))
                .sort((a, b) => a.val - b.val)
                .map(obj => obj.idx);

            const caterpillarTrace = {
                x: sortedIndices.map(i => caterpillarData.oeRatio[i]),
                y: sortedIndices.map((i, idx) => idx),
                mode: 'markers',
                marker: {
                    size: 8,
                    color: sortedIndices.map(i => 
                        caterpillarData.significant[i] ? 
                        (caterpillarData.oeRatio[i] > 1 ? '#e74c3c' : '#27ae60') : 
                        '#95a5a6'
                    )
                },
                name: 'O/E Ratio',
                error_x: {
                    type: 'data',
                    symmetric: false,
                    arrayminus: sortedIndices.map(i => caterpillarData.oeRatio[i] - caterpillarData.lowerCI[i]),
                    array: sortedIndices.map(i => caterpillarData.upperCI[i] - caterpillarData.oeRatio[i]),
                    thickness: 1.5,
                    width: 0,
                    color: 'gray'
                },
                text: sortedIndices.map(i => 
                    `${caterpillarData.physicians[i]}<br>O/E: ${caterpillarData.oeRatio[i].toFixed(2)}<br>95% CI: [${caterpillarData.lowerCI[i].toFixed(2)}, ${caterpillarData.upperCI[i].toFixed(2)}]`
                ),
                hovertemplate: '%{text}<extra></extra>',
                type: 'scatter'
            };

            // Reference line at 1.0
            const refLine = {
                x: [1, 1],
                y: [-1, 20],
                mode: 'lines',
                line: {color: 'black', dash: 'dash', width: 2},
                name: 'Expected (1.0)',
                hoverinfo: 'skip'
            };

            const layout10 = {
                xaxis: {
                    title: 'Observed/Expected Ratio',
                    range: [0.7, 1.4]
                },
                yaxis: {
                    title: 'Physician (Anonymized)',
                    tickmode: 'array',
                    tickvals: Array.from({length: 20}, (_, i) => i),
                    ticktext: sortedIndices.map(i => caterpillarData.physicians[i]),
                    automargin: true
                },
                height: 500,
                showlegend: false,
                margin: {l: 80},
                annotations: [{
                    x: 1.35,
                    y: 18,
                    text: 'Red = Significantly Higher<br>Green = Significantly Lower<br>Gray = Not Significant',
                    showarrow: false,
                    font: {size: 10},
                    align: 'left',
                    bgcolor: 'rgba(255,255,255,0.9)',
                    bordercolor: 'gray',
                    borderwidth: 1
                }]
            };

            Plotly.newPlot('caterpillar-plot', [caterpillarTrace, refLine], layout10, {responsive: true, displayModeBar: false});
        });
    </script>
</body>
</html>
