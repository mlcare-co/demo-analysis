<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAC Analysis - Visualization Suite</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #f5f7fa;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #e74c3c;
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        
        h2 {
            color: #34495e;
            margin-top: 40px;
            margin-bottom: 20px;
            padding: 10px;
            background: #fee;
            border-left: 4px solid #e74c3c;
        }
        
        .chart-container {
            margin: 30px 0;
            padding: 20px;
            background: #fdfdfd;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .metric-card {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .metric-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .insight-box {
            background: #fee;
            border-left: 4px solid #e74c3c;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        
        .table-container {
            overflow-x: auto;
            margin: 20px 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        th {
            background: #c0392b;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        
        td {
            padding: 10px 12px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .footer {
            margin-top: 50px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
            text-align: center;
            color: #7f8c8d;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Hospital-Acquired Conditions (HAC) Analysis - 500-Bed European Hospital</h1>
        
        <div class="insight-box">
            <strong>Analysis Period:</strong> January 2024 - December 2024<br>
            <strong>Total Discharges:</strong> 15,000 patients<br>
            <strong>Methodology:</strong> Analysis of preventable complications acquired during hospitalization
        </div>

        <!-- Key Metrics Dashboard -->
        <h2>Executive Summary Metrics</h2>
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-label">Overall HAC Rate</div>
                <div class="metric-value">4.8%</div>
                <div class="metric-label">720 cases</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Additional LOS per HAC</div>
                <div class="metric-value">+4.2 days</div>
                <div class="metric-label">vs non-HAC patients</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Total Excess Bed-Days</div>
                <div class="metric-value">3,024</div>
                <div class="metric-label">from HAC cases</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Financial Impact</div>
                <div class="metric-value">€2.1M</div>
                <div class="metric-label">additional costs</div>
            </div>
        </div>

        <!-- Chart 1: HAC Rate Trend -->
        <h2>1. Monthly HAC Rate Trend</h2>
        <div class="chart-container">
            <div class="chart-title">HAC Rate Over Time with Control Limits</div>
            <div id="hac-trend-chart"></div>
        </div>

        <!-- Chart 2: HAC Types Distribution -->
        <h2>2. Distribution of HAC Types</h2>
        <div class="chart-container">
            <div class="chart-title">Breakdown by Complication Category</div>
            <div id="hac-types-chart"></div>
        </div>

        <!-- Chart 3: Department HAC Rates -->
        <h2>3. HAC Rates by Department</h2>
        <div class="chart-container">
            <div class="chart-title">Risk-Adjusted HAC Rates with Volume</div>
            <div id="department-hac-chart"></div>
        </div>

        <!-- Chart 4: Impact on LOS -->
        <h2>4. HAC Impact on Length of Stay</h2>
        <div class="chart-container">
            <div class="chart-title">Mean LOS: HAC vs Non-HAC Patients</div>
            <div id="los-impact-chart"></div>
        </div>

        <!-- Chart 5: Risk Factor Analysis -->
        <h2>5. HAC Risk Factor Analysis</h2>
        <div class="chart-container">
            <div class="chart-title">HAC Rate by Patient Risk Factors</div>
            <div id="risk-factors-chart"></div>
        </div>

        <!-- Chart 6: Financial Impact Waterfall -->
        <h2>6. HAC Financial Impact Analysis</h2>
        <div class="chart-container">
            <div class="chart-title">Cost Build-up from HACs</div>
            <div id="hac-waterfall-chart"></div>
        </div>

        <!-- Chart 7: DRG-HAC Heatmap -->
        <h2>7. HAC Rate by DRG and Department</h2>
        <div class="chart-container">
            <div class="chart-title">High-Risk Procedure Matrix</div>
            <div id="drg-hac-heatmap"></div>
        </div>

        <!-- Chart 8: Time to HAC -->
        <h2>8. Time to HAC Development</h2>
        <div class="chart-container">
            <div class="chart-title">Days from Admission to HAC Onset</div>
            <div id="time-to-hac-chart"></div>
        </div>

        <!-- Chart 9: Physician Scatter -->
        <h2>9. Physician HAC Performance (Risk-Adjusted)</h2>
        <div class="chart-container">
            <div class="chart-title">Expected vs Actual HAC Rates by Physician</div>
            <div id="physician-hac-scatter"></div>
        </div>

        <!-- Chart 10: Statistical Significance -->
        <h2>10. Physician HAC Rates - Statistical Analysis</h2>
        <div class="chart-container">
            <div class="chart-title">HAC Rates with 95% Confidence Intervals</div>
            <div id="physician-caterpillar"></div>
        </div>

        <!-- Data Table -->
        <h2>11. HAC Detail by Department</h2>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Department</th>
                        <th>Discharges</th>
                        <th>HAC Cases</th>
                        <th>HAC Rate</th>
                        <th>Most Common HAC</th>
                        <th>Excess LOS</th>
                        <th>Financial Impact</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Orthopedics</td>
                        <td>2,100</td>
                        <td>168</td>
                        <td>8.0%</td>
                        <td>SSI (42%)</td>
                        <td>706 days</td>
                        <td>€493,200</td>
                    </tr>
                    <tr>
                        <td>General Surgery</td>
                        <td>1,950</td>
                        <td>137</td>
                        <td>7.0%</td>
                        <td>SSI (38%)</td>
                        <td>575 days</td>
                        <td>€401,500</td>
                    </tr>
                    <tr>
                        <td>Internal Medicine</td>
                        <td>3,200</td>
                        <td>160</td>
                        <td>5.0%</td>
                        <td>CAUTI (35%)</td>
                        <td>672 days</td>
                        <td>€469,200</td>
                    </tr>
                    <tr>
                        <td>Cardiology</td>
                        <td>2,850</td>
                        <td>114</td>
                        <td>4.0%</td>
                        <td>CLABSI (30%)</td>
                        <td>479 days</td>
                        <td>€334,500</td>
                    </tr>
                    <tr>
                        <td>Neurology</td>
                        <td>1,150</td>
                        <td>46</td>
                        <td>4.0%</td>
                        <td>Falls (28%)</td>
                        <td>193 days</td>
                        <td>€134,800</td>
                    </tr>
                    <tr>
                        <td>Pulmonology</td>
                        <td>1,400</td>
                        <td>42</td>
                        <td>3.0%</td>
                        <td>VAP (45%)</td>
                        <td>176 days</td>
                        <td>€123,000</td>
                    </tr>
                    <tr>
                        <td>Gastroenterology</td>
                        <td>950</td>
                        <td>29</td>
                        <td>3.1%</td>
                        <td>CDI (40%)</td>
                        <td>122 days</td>
                        <td>€85,200</td>
                    </tr>
                    <tr>
                        <td>Oncology</td>
                        <td>800</td>
                        <td>16</td>
                        <td>2.0%</td>
                        <td>CLABSI (50%)</td>
                        <td>67 days</td>
                        <td>€46,800</td>
                    </tr>
                    <tr>
                        <td>Nephrology</td>
                        <td>600</td>
                        <td>8</td>
                        <td>1.3%</td>
                        <td>CAUTI (63%)</td>
                        <td>34 days</td>
                        <td>€23,700</td>
                    </tr>
                    <tr style="font-weight: bold; background: #f0f0f0;">
                        <td>TOTAL</td>
                        <td>15,000</td>
                        <td>720</td>
                        <td>4.8%</td>
                        <td>SSI (31%)</td>
                        <td>3,024 days</td>
                        <td>€2,111,900</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="insight-box">
            <strong>Key Findings:</strong><br>
            • Surgical specialties (Orthopedics, General Surgery) show highest HAC rates at 8.0% and 7.0%<br>
            • Surgical Site Infections (SSI) represent 31% of all HACs<br>
            • HAC patients stay average 4.2 days longer than non-HAC patients<br>
            • 82% of HACs occur within first 5 days of admission<br>
            • Total financial impact of €2.1M from additional care requirements
        </div>

        <div class="footer">
            Data Analysis Period: January 2024 - December 2024 | 500-Bed Hospital | 720 HAC Cases
        </div>
    </div>

    <script>
        // Wait for Plotly to load
        window.addEventListener('load', function() {
            
            // Chart 1: HAC Rate Trend
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const hacRates = [5.2, 5.0, 4.9, 4.6, 4.7, 4.8, 4.5, 4.6, 4.8, 4.9, 5.0, 5.1];
            const centerLine = 4.8;
            const ucl = 6.2; // Upper control limit
            const lcl = 3.4; // Lower control limit

            const trendTrace = {
                x: months,
                y: hacRates,
                name: 'Monthly HAC Rate',
                type: 'scatter',
                mode: 'lines+markers',
                line: {color: '#e74c3c', width: 3},
                marker: {size: 8}
            };

            const centerTrace = {
                x: months,
                y: new Array(12).fill(centerLine),
                name: 'Mean (4.8%)',
                mode: 'lines',
                line: {color: 'gray', dash: 'dash', width: 2}
            };

            const uclTrace = {
                x: months,
                y: new Array(12).fill(ucl),
                name: 'UCL',
                mode: 'lines',
                line: {color: 'orange', dash: 'dot', width: 1}
            };

            const lclTrace = {
                x: months,
                y: new Array(12).fill(lcl),
                name: 'LCL',
                mode: 'lines',
                line: {color: 'orange', dash: 'dot', width: 1}
            };

            const layout1 = {
                yaxis: {title: 'HAC Rate (%)', range: [3, 7]},
                xaxis: {
                    title: 'Month (2024)', 
                    type: 'category',
                    categoryorder: 'array',
                    categoryarray: months,
                    tickmode: 'linear'
                },
                height: 400,
                hovermode: 'x unified',
                margin: {l: 60, r: 40, t: 40, b: 60},
                autosize: true
            };

            Plotly.newPlot('hac-trend-chart', [trendTrace, centerTrace, uclTrace, lclTrace], layout1);

            // Chart 2: HAC Types Distribution
            const hacTypes = {
                types: ['Surgical Site<br>Infection', 'CAUTI', 'CLABSI', 'Falls', 'Pressure<br>Ulcers', 
                        'VAP', 'CDI', 'VTE', 'Other'],
                count: [223, 151, 108, 72, 58, 43, 36, 21, 8],
                percentage: [31.0, 21.0, 15.0, 10.0, 8.1, 6.0, 5.0, 2.9, 1.0]
            };

            const typesTrace = {
                x: hacTypes.count,
                y: hacTypes.types,
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: ['#e74c3c', '#c0392b', '#a93226', '#922b21', '#7b241c', 
                            '#641e16', '#5d1914', '#4e1511', '#3e110e']
                },
                text: hacTypes.count.map((c, i) => `${c} (${hacTypes.percentage[i]}%)`),
                textposition: 'outside',
                hovertemplate: '%{y}: %{x} cases<extra></extra>'
            };

            const layout2 = {
                xaxis: {title: 'Number of Cases'},
                margin: {l: 150},
                height: 400
            };

            Plotly.newPlot('hac-types-chart', [typesTrace], layout2);

            // Chart 3: Department HAC Rates
            const deptHacData = {
                departments: ['Orthopedics', 'General Surgery', 'Internal Medicine', 'Cardiology', 
                             'Neurology', 'Gastroenterology', 'Pulmonology', 'Oncology', 'Nephrology'],
                rates: [8.0, 7.0, 5.0, 4.0, 4.0, 3.1, 3.0, 2.0, 1.3],
                volume: [2100, 1950, 3200, 2850, 1150, 950, 1400, 800, 600],
                expected: [6.5, 6.0, 4.5, 4.2, 3.8, 3.5, 3.3, 2.5, 2.0]
            };

            const deptTrace1 = {
                x: deptHacData.departments,
                y: deptHacData.rates,
                name: 'Actual HAC Rate',
                type: 'bar',
                marker: {color: '#e74c3c'},
                text: deptHacData.rates.map(r => `${r}%`),
                textposition: 'outside'
            };

            const deptTrace2 = {
                x: deptHacData.departments,
                y: deptHacData.expected,
                name: 'Expected Rate',
                type: 'scatter',
                mode: 'markers',
                marker: {
                    size: 10,
                    color: '#2c3e50',
                    symbol: 'diamond'
                }
            };

            const layout3 = {
                yaxis: {title: 'HAC Rate (%)'},
                xaxis: {tickangle: -45},
                height: 450,
                barmode: 'group'
            };

            Plotly.newPlot('department-hac-chart', [deptTrace1, deptTrace2], layout3);

            // Chart 4: Impact on LOS
            const losImpactData = {
                categories: ['Overall', 'SSI', 'CAUTI', 'CLABSI', 'Falls', 'Pressure<br>Ulcers', 'VAP', 'CDI'],
                hacLOS: [10.1, 12.3, 9.8, 11.2, 8.5, 10.5, 14.2, 9.2],
                nonHacLOS: [5.9, 5.9, 5.9, 5.9, 5.9, 5.9, 5.9, 5.9],
                difference: [4.2, 6.4, 3.9, 5.3, 2.6, 4.6, 8.3, 3.3]
            };

            const losTrace1 = {
                x: losImpactData.categories,
                y: losImpactData.hacLOS,
                name: 'HAC Patients',
                type: 'bar',
                marker: {color: '#e74c3c'}
            };

            const losTrace2 = {
                x: losImpactData.categories,
                y: losImpactData.nonHacLOS,
                name: 'Non-HAC Patients',
                type: 'bar',
                marker: {color: '#3498db'}
            };

            const layout4 = {
                barmode: 'group',
                yaxis: {title: 'Mean LOS (days)'},
                xaxis: {tickangle: -45},
                height: 450
            };

            Plotly.newPlot('los-impact-chart', [losTrace1, losTrace2], layout4);

            // Chart 5: Risk Factor Analysis
            const riskData = {
                factors: ['Age 80+', 'Age 65-79', 'Age <65', 'Emergency<br>Admit', 'Elective<br>Admit',
                          'Diabetes', 'No Diabetes', 'Obesity', 'Normal BMI', 'Smoker', 'Non-Smoker'],
                rates: [7.8, 5.2, 2.9, 6.1, 3.5, 6.8, 4.2, 6.2, 4.1, 5.9, 4.5]
            };

            const riskTrace = {
                x: riskData.rates,
                y: riskData.factors,
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: riskData.rates,
                    colorscale: [
                        [0, '#27ae60'],
                        [0.5, '#f39c12'],
                        [1, '#e74c3c']
                    ],
                    cmin: 2,
                    cmax: 8
                },
                text: riskData.rates.map(r => `${r}%`),
                textposition: 'outside'
            };

            const layout5 = {
                xaxis: {title: 'HAC Rate (%)'},
                margin: {l: 120},
                height: 450
            };

            Plotly.newPlot('risk-factors-chart', [riskTrace], layout5);

            // Chart 6: Financial Waterfall
            const waterfallData = {
                x: ['Base Cost<br>(Non-HAC)', 'Additional<br>LOS', 'ICU<br>Requirements', 'Medications', 
                    'Procedures', 'Readmissions', 'Total Cost<br>(HAC)'],
                y: [0, 980000, 450000, 280000, 220000, 181900, 0],
                measure: ['absolute', 'relative', 'relative', 'relative', 'relative', 'relative', 'total'],
                text: ['€5,800', '+€980k', '+€450k', '+€280k', '+€220k', '+€182k', '€7,712'],
                textposition: 'outside',
                connector: {line: {color: 'rgb(63, 63, 63)'}},
                increasing: {marker: {color: '#e74c3c'}},
                totals: {marker: {color: '#c0392b'}}
            };

            const waterfallTrace = {
                type: 'waterfall',
                orientation: 'v',
                x: waterfallData.x,
                y: waterfallData.y,
                text: waterfallData.text,
                textposition: waterfallData.textposition,
                measure: waterfallData.measure,
                connector: waterfallData.connector,
                increasing: waterfallData.increasing,
                totals: waterfallData.totals
            };

            const layout6 = {
                yaxis: {title: 'Cost (€)', tickformat: ',.0f'},
                height: 450,
                showlegend: false
            };

            Plotly.newPlot('hac-waterfall-chart', [waterfallTrace], layout6);

            // Chart 7: DRG-HAC Heatmap
            const heatmapData = {
                z: [
                    [12.5, 8.2, 6.3, 4.1, 3.2],
                    [10.8, 7.5, 5.8, 3.9, 2.8],
                    [6.2, 5.1, 4.3, 3.2, 2.1],
                    [5.8, 4.2, 3.5, 2.8, 1.9],
                    [4.5, 3.8, 3.1, 2.2, 1.5]
                ],
                x: ['DRG 470<br>(Hip/Knee)', 'DRG 481<br>(Hip Fx)', 'DRG 853<br>(Infection)', 
                    'DRG 291<br>(CHF)', 'DRG 871<br>(Sepsis)'],
                y: ['Orthopedics', 'Surgery', 'Medicine', 'Cardiology', 'Neurology'],
                colorscale: [
                    [0, '#27ae60'],
                    [0.05, '#f1c40f'],
                    [0.1, '#e74c3c'],
                    [1, '#922b21']
                ],
                type: 'heatmap',
                hovertemplate: '%{y}<br>%{x}<br>HAC Rate: %{z}%<extra></extra>',
                colorbar: {title: 'HAC Rate (%)'}
            };

            const layout7 = {
                xaxis: {title: 'High-Risk DRGs', side: 'top'},
                yaxis: {title: 'Department'},
                height: 400
            };

            Plotly.newPlot('drg-hac-heatmap', [heatmapData], layout7);

            // Chart 8: Time to HAC
            const timeToHacData = {
                days: ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Day 7', 'Day 8+'],
                cases: [86, 144, 173, 137, 101, 43, 22, 14],
                cumulative: [12, 32, 56, 75, 89, 95, 98, 100]
            };

            const timeTrace1 = {
                x: timeToHacData.days,
                y: timeToHacData.cases,
                name: 'HAC Cases',
                type: 'bar',
                marker: {color: '#e74c3c'},
                yaxis: 'y'
            };

            const timeTrace2 = {
                x: timeToHacData.days,
                y: timeToHacData.cumulative,
                name: 'Cumulative %',
                type: 'scatter',
                mode: 'lines+markers',
                line: {color: '#2c3e50', width: 3},
                marker: {size: 8},
                yaxis: 'y2'
            };

            const layout8 = {
                yaxis: {title: 'Number of HAC Cases'},
                yaxis2: {
                    title: 'Cumulative Percentage',
                    overlaying: 'y',
                    side: 'right',
                    range: [0, 100]
                },
                xaxis: {title: 'Days from Admission'},
                height: 400
            };

            Plotly.newPlot('time-to-hac-chart', [timeTrace1, timeTrace2], layout8);

            // Chart 9: Physician HAC Scatter
            const scatterData = {
                physicians: [],
                expected: [],
                actual: [],
                volume: [],
                specialty: []
            };

            // Generate 40 physicians with realistic HAC data
            const specialties = ['Surgery', 'Orthopedics', 'Medicine', 'Cardiology', 'Other'];
            for(let i = 1; i <= 40; i++) {
                scatterData.physicians.push(`MD${String(i).padStart(3, '0')}`);
                const exp = 2 + Math.random() * 6; // Expected HAC rate 2-8%
                scatterData.expected.push(exp);
                // Add variation around expected
                const variation = (Math.random() - 0.5) * 4 + 0.5;
                scatterData.actual.push(Math.max(0, exp + variation));
                scatterData.volume.push(100 + Math.floor(Math.random() * 400));
                scatterData.specialty.push(specialties[Math.floor(Math.random() * specialties.length)]);
            }

            // Color by performance
            const colors = scatterData.actual.map((act, i) => {
                const diff = act - scatterData.expected[i];
                if(diff > 2) return '#e74c3c';
                if(diff > 1) return '#f39c12';
                return '#27ae60';
            });

            const scatterTrace = {
                x: scatterData.expected,
                y: scatterData.actual,
                mode: 'markers',
                marker: {
                    size: scatterData.volume.map(v => v/10),
                    color: colors,
                    opacity: 0.7,
                    line: {
                        color: 'white',
                        width: 1
                    }
                },
                text: scatterData.physicians.map((p, i) => 
                    `${p}<br>Specialty: ${scatterData.specialty[i]}<br>Volume: ${scatterData.volume[i]} cases<br>Expected: ${scatterData.expected[i].toFixed(1)}%<br>Actual: ${scatterData.actual[i].toFixed(1)}%`
                ),
                hovertemplate: '%{text}<extra></extra>',
                type: 'scatter'
            };

            // Perfect performance line
            const perfLine = {
                x: [0, 10],
                y: [0, 10],
                mode: 'lines',
                line: {color: 'gray', dash: 'dash'},
                name: 'Perfect Performance',
                hoverinfo: 'skip'
            };

            // Control limit lines (±2%)
            const upperControl = {
                x: [0, 10],
                y: [2, 12],
                mode: 'lines',
                line: {color: 'orange', dash: 'dot'},
                name: '+2% Threshold',
                hoverinfo: 'skip'
            };

            const lowerControl = {
                x: [0, 10],
                y: [-2, 8],
                mode: 'lines',
                line: {color: 'orange', dash: 'dot'},
                name: '-2% Threshold',
                hoverinfo: 'skip'
            };

            const layout9 = {
                xaxis: {title: 'Expected HAC Rate (Risk-Adjusted %)', range: [0, 10]},
                yaxis: {title: 'Actual HAC Rate (%)', range: [0, 12]},
                height: 450,
                showlegend: false,
                annotations: [{
                    x: 9,
                    y: 11,
                    text: 'Size = Volume',
                    showarrow: false,
                    font: {size: 11, color: 'gray'}
                }]
            };

            Plotly.newPlot('physician-hac-scatter', [scatterTrace, perfLine, upperControl, lowerControl], layout9);

            // Chart 10: Physician Caterpillar Plot
            const caterpillarData = {
                physicians: [],
                hacRate: [],
                lowerCI: [],
                upperCI: [],
                significant: []
            };

            // Generate data for top 20 physicians by volume
            const benchmark = 4.8; // Hospital average
            for(let i = 1; i <= 20; i++) {
                const physician = `MD${String(i).padStart(3, '0')}`;
                const rate = 1.5 + Math.random() * 8; // HAC rate between 1.5% and 9.5%
                const ciWidth = 0.8 + Math.random() * 1.5; // CI width varies by volume
                
                caterpillarData.physicians.push(physician);
                caterpillarData.hacRate.push(rate);
                caterpillarData.lowerCI.push(Math.max(0, rate - ciWidth));
                caterpillarData.upperCI.push(rate + ciWidth);
                // Significant if CI doesn't overlap with benchmark
                caterpillarData.significant.push(
                    (rate - ciWidth > benchmark) || (rate + ciWidth < benchmark)
                );
            }

            // Sort by HAC rate
            const sortedIndices = caterpillarData.hacRate
                .map((val, idx) => ({val, idx}))
                .sort((a, b) => a.val - b.val)
                .map(obj => obj.idx);

            const caterpillarTrace = {
                x: sortedIndices.map(i => caterpillarData.hacRate[i]),
                y: sortedIndices.map((i, idx) => idx),
                mode: 'markers',
                marker: {
                    size: 8,
                    color: sortedIndices.map(i => 
                        caterpillarData.significant[i] ? 
                        (caterpillarData.hacRate[i] > benchmark ? '#e74c3c' : '#27ae60') : 
                        '#95a5a6'
                    )
                },
                name: 'HAC Rate',
                error_x: {
                    type: 'data',
                    symmetric: false,
                    arrayminus: sortedIndices.map(i => caterpillarData.hacRate[i] - caterpillarData.lowerCI[i]),
                    array: sortedIndices.map(i => caterpillarData.upperCI[i] - caterpillarData.hacRate[i]),
                    thickness: 1.5,
                    width: 0,
                    color: 'gray'
                },
                text: sortedIndices.map(i => 
                    `${caterpillarData.physicians[i]}<br>HAC Rate: ${caterpillarData.hacRate[i].toFixed(1)}%<br>95% CI: [${caterpillarData.lowerCI[i].toFixed(1)}%, ${caterpillarData.upperCI[i].toFixed(1)}%]`
                ),
                hovertemplate: '%{text}<extra></extra>',
                type: 'scatter'
            };

            // Reference line at hospital average
            const refLine = {
                x: [benchmark, benchmark],
                y: [-1, 20],
                mode: 'lines',
                line: {color: 'black', dash: 'dash', width: 2},
                name: 'Hospital Avg (4.8%)',
                hoverinfo: 'skip'
            };

            const layout10 = {
                xaxis: {
                    title: 'HAC Rate (%)',
                    range: [0, 12]
                },
                yaxis: {
                    title: 'Physician (Anonymized)',
                    tickmode: 'array',
                    tickvals: Array.from({length: 20}, (_, i) => i),
                    ticktext: sortedIndices.map(i => caterpillarData.physicians[i]),
                    automargin: true
                },
                height: 500,
                showlegend: false,
                margin: {l: 80},
                annotations: [{
                    x: 11,
                    y: 18,
                    text: 'Red = Significantly Higher<br>Green = Significantly Lower<br>Gray = Not Significant',
                    showarrow: false,
                    font: {size: 10},
                    align: 'left',
                    bgcolor: 'rgba(255,255,255,0.9)',
                    bordercolor: 'gray',
                    borderwidth: 1
                }]
            };

            Plotly.newPlot('physician-caterpillar', [caterpillarTrace, refLine], layout10);
        });
    </script>
</body>
</html>